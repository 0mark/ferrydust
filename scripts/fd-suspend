#!SHELL_FULL

# exit on error
#set -e

source ETCPREFIX/ferrydust/system.rc
source LIBPREFIX/fd-functions

function susprep {
    fd-unotify -a ferrydust "Falling asleep..."

    logger -t suspend "sleeping down"
    fd-mount umount_all
    if [ $? -ne 0 ]; then
        logger -t suspend "Suspend failed due to unmounted file systems"
        fd-unotify -a ferrydust "Suspend failed due to unmounted file systems"
        exit 1
    fi
    umount -a -t nfs,cifs,davfs,smbfs
    if [ $? -ne 0 ]; then
        logger -t suspend "Suspend failed due to unmounted file systems"
        fd-unotify -a ferrydust "Suspend failed due to unmounted file systems"
        exit 1
    fi
    $NET_DOWN
    BINPREFIX/fd-ulock &
    sleep 0.2
    sync
    logger -t suspend "sleeping now..."
}

function suspres {
    logger -t suspend "waking up"
    $NET_UP
    if [ "$(</sys/class/power_supply/AC/online)" -ne 1 ]; then
        { sleep 5; BINPREFIX/fd-pm down } &
    else
        { sleep 5; BINPREFIX/fd-pm up } &
    fi
    logger -t suspend "woken up"

    fd-unotify -a ferrydust "Woken up"
}

to=$1

if [ "$1" == "hybrid" -o "$1" == "disk" ]; then
    match=`cat /proc/version | grep "$(ls -c /lib/modules | head -n 1)" | wc -l`
    if [ "$match" -lt 1 ]; then
        if [ "$1" == "hybrid" ]; then
            logger -t suspend "Kernel Version mismatch, can't s2h, falling back to s2r."
            to="mem"
        else
            logger -t suspend "Kernel Version mismatch, can't s2d."
            exit
        fi
    fi
fi

susprep
if [ "$to" == "disk" ]; then
    if [ "$SUSPEND_HYBRID" == "true" ]; then
        now="$(date -u +%s)"
        rtcwake -u -m mem -s "$HYBRID_SUSPEND_TIMEOUT"
        dif="$(($(date -u +%s) - $now))"
        if (( $dif >= "$HYBRID_SUSPEND_TIMEOUT" )); then
            sleep 5
            echo -n disk >/sys/power/state
            # TODO: s2r on fail
            # TODO: kill lock else
        fi
    else
        echo -n disk >/sys/power/state
    fi
else
    echo -n mem >/sys/power/state
fi
suspres
